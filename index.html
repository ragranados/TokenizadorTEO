<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.3.1/css/bootstrap.min.css"
        integrity="sha384-ggOyR0iXCbMQv3Xipma34MD+dH/1fQ784/j6cY/iJTQUOhcWr7x9JvoRxT2MZw1T" crossorigin="anonymous">
    <title>Tokenizador TEO</title>
</head>

<body>
    <div class="container mt-3">
        <div class="jumbotron">
            <h1 class="display-4">Tokenizador </h1>
            <p class="lead">
                El siguiente programa es un simple tokenizador del lenguaje Kotlin desarrollado en JavaScript
            </p>

            <hr class="my-4">
            <div class="form-group">
                <label for="exampleInputEmail1">Codigo fuente Kotlin:</label>
                <textarea class="form-control" rows="10" id="code" aria-describedby="emailHelp"
                    placeholder="Código en Kotlin"></textarea>
                <small id="emailHelp" class="form-text text-muted">Ingrese el fragmento de código escrito en
                    Kotlin.</small>
            </div>
            <div class="form-group">
                <button id="go" class="btn btn-primary">Tokenizar</button>
            </div>
        </div>
        <hr>
        <div class="card">
            <div class="card-body">
                Resultado:
                <div id="resultado">

                </div>
            </div>
        </div>
    </div>
</body>

</html>

<script>
    let btn = document.getElementById("go")
    btn.addEventListener("click", () => {
        document.getElementById("resultado").innerHTML = ""
        const sustituto = /^\@+$/;
        const comentario = /\/\/.*/
        const comentarioB = /(\/\*).*(\*\/)/
        const codigo = document.getElementById("code").value
        const regexs = [
            {
                exp:/(\w+[* ]+){1,2}\w+\(((\w*[* ]+[&]?){1,2}\w+,? *)*\)+\s*\{/,
                nombre:"<Declaracion de funcion>"
            },
            {
                //TODO: Declaracion de arreglo si se cuentra un tipo de dato antes de este regex
                exp:/(([a-z]|[A-Z]|_)([a-z]|[A-Z]|\d|_)*\[\d+\])/,
                nombre:"<Acceso a arreglo por indice>"
            },
            {
                exp:/^[for]+[\s]*[(]+.+;+.+;+.+[)]+[\s]*{{1}$/,
                nombre:"<Instruccion de iteracion for>"
            },
            {
                exp: /(int)|(float)|(char)/g,
                nombre: "<Tipo de dato>"
            },
            {
                exp:/(if)|(else)/,
                nombre:"<Condicional>"
            },
            {
                exp: /(int)|(float)|(char)|(return)|(void)|(if)|(else)/g,
                nombre: "<Palabra Reservada>"
            },
            {
                exp: /\/\/.*/,
                nombre: ""
            },
            {
                //TODO: Validar si encuentra el simbolo /* y que ignore hasta encontrar */
                exp: /\/(\n*.*?\n*)*?\//,
                nombre: ""
            },
            {
                //TODO: Tomar como identificador tambien si se encuentra un tipo de dato seguido de este regex
                exp: /([a-z]|[A-Z]|_)([a-z]|[A-Z]|\d|_)*/,
                nombre: "<Identificador>"
            },
            {
                exp: /(\&\&)|(\|\|)|(\!)|(\=\=)/,
                nombre: "<Operador logico>"
            },
            {
                exp: /=/,
                nombre: "<Simbolo asignacion>"
            },
            {
                exp: /[\+\-\*\/*\%][\+\-\*\/\%+]*[\+\-\*\/\%+]*[\+\-\*\/*\%]*/,
                nombre: "<Operador aritmeticos>"
            },
            {
                exp: /[\<\>][\<\>]*[\<\>]*[\<\>]*/,
                nombre: "<Comparador>"
            },
            {
                exp: /{/,
                nombre: "<Abrir bloque>"
            },
            {
                exp: /}/,
                nombre: "<Cerrar bloque>"
            },
            {
                exp: /\(/,
                nombre: "<Abrir Perentesis>"
            },
            {
                exp: /\)/,
                nombre: "<Cerrar Perentesis>"
            },
            {
                exp: /\[/,
                nombre: "<Abrir corchete>"
            },
            {
                exp: /\]/,
                nombre: "<Cerrar corchete>"
            },
            {
                exp: /(")((?:\\\1|(?:(?!\1).))*)(\1)/,
                nombre: "<Cadena de Texto>"
            },
            {
                exp: /(')((?:\\\1|(?:(?!\1).))*)(\1)/,
                nombre: "<Caracter>"
            },
            {
                exp: /\d+(\.\d+)?/,
                nombre: "<Constante numerica>"
            },
            {
                exp: /;/,
                nombre: "<Fin instruccion>"
            },
            {
                exp: /[\$\|\^\~\°\¬\!\#\%\&\¡\¨\´\`\\\.\,][\$\|\^\~\°\¬\!\#\%\&\¡\¨\´\`\\\.\,]*[\$\|\^\~\°\¬\!\#\%\&\¡\¨\´\`\\\.\,]*/,
                nombre: "<Simbolo no reconocido>"
            }

        ]

        const bloques = codigo.split(/\n+/);
        var emergencia = true, i = 0;

        bloques.forEach((bloque) => {
            i = 0;
            var tokens = [];

            if (!bloque.match(comentario) && !bloque.match(comentarioB)) {
                let container = document.createElement("div")
                container.style.display = "flex"
                container.style.alignItems = "baseline"
                let title = document.createElement("h6")
                title.appendChild(document.createTextNode("Bloque: "))
                title.style.marginRight = "10px"
                let value = document.createElement("code")
                value.appendChild(document.createTextNode(" " + bloque))
                container.appendChild(title)
                container.appendChild(value)
                document.getElementById("resultado").appendChild(container)

                console.log("\nBloque: ", bloque);
            }

            while (!sustituto.exec(bloque) && emergencia) {
                i++;
                regexs.forEach((regex) => {

                    const ejecucion = regex.exp.exec(bloque);
                    if (ejecucion) {
                        tokens[ejecucion.index] = regex.nombre;
                        bloque = bloque.replace(ejecucion[0], "@".repeat(ejecucion[0].length));
                    }
                });

                if (i == 50) {
                    emergencia = false;
                }
            }

            emergencia = true;
            for (indice2 in tokens) {
                let contain = document.createElement("div")
                let token = document.createElement("small")
                token.appendChild(document.createTextNode(tokens[indice2]))
                contain.appendChild(token)
                document.getElementById("resultado").appendChild(contain)


                console.log(tokens[indice2])
            }

        })
    })

</script>
<script>
    document.getElementById('code').addEventListener('keydown', function (e) {
        if (e.key == 'Tab') {
            e.preventDefault();
            var start = this.selectionStart;
            var end = this.selectionEnd;

            // set textarea value to: text before caret + tab + text after caret
            this.value = this.value.substring(0, start) +
                "\t" + this.value.substring(end);

            // put caret at right position again
            this.selectionStart =
                this.selectionEnd = start + 1;
        }
    });
</script>